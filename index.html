<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OC Scanner • Multiviewer</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #0f1720;
      --muted: #9aa;
      --accent: #0a84ff;
      --text: #eef;
    }
    html,body{height:100%}
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      padding:16px;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header { display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap }
    h1 { font-size:1.1rem; margin:0 }
    .note { color:var(--muted); font-size:0.9rem }
    .groups { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:12px }
    .group { background:var(--card); border:1px solid rgba(255,255,255,0.03); padding:12px; border-radius:8px }
    .group h2 { margin:0 0 8px 0; font-size:1rem; color:var(--text) }
    .channel { display:flex; gap:12px; align-items:flex-start; margin-bottom:12px }
    .thumb { width:160px; height:90px; background:#000; display:flex; align-items:center; justify-content:center; color:#999; border-radius:6px; overflow:hidden; flex:0 0 160px; }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .meta { flex:1; min-width:0 }
    .meta .name { font-weight:600; margin-bottom:6px; word-break:break-word }
    .meta .actions { display:flex; gap:8px; align-items:center }
    button.play { background:var(--accent); color:white; border:0; padding:8px 10px; border-radius:6px; cursor:pointer; font-weight:600 }
    a.fallback { color:#9cc; font-size:0.9rem; text-decoration:none }
    .small { font-size:0.85rem; color:var(--muted) }
    .iframe-wrap { width:100%; max-width:100%; border-radius:6px; overflow:hidden; background:#000; }
    .blocked { color:#f88; font-weight:600; }
    footer { margin-top:18px; color:var(--muted); font-size:0.85rem }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Multiviewer</h1>
    <div class="note">Click Play to load a stream (lazy-loaded to save CPU & bandwidth). Use "Open in new tab" if embedding is blocked.</div>
  </header>

  <main>
    <div id="groups" class="groups" aria-live="polite"></div>
    <footer>
      Note: Some sites prevent embedding (X-Frame-Options or CSP). If a stream doesn't load, open it directly.
    </footer>
  </main>

  <!-- Channel configuration file (edit channels.js) -->
  <script src="channels.js"></script>

  <script>
    // Basic render + safe lazy embedding
    const titleEl = document.getElementById('title');
    if (window.APP_CONFIG && window.APP_CONFIG.title) titleEl.textContent = window.APP_CONFIG.title;

    const groupsContainer = document.getElementById('groups');
    const CHANNELS = window.CHANNEL_GROUPS || {};

    // extract a likely YouTube id from several common embed/watch URL forms
    function extractYoutubeId(url) {
      if (!url) return null;
      const patterns = [
        /youtube\.com\/embed\/([A-Za-z0-9_\-]+)/,
        /youtube\.com\/watch\?v=([A-Za-z0-9_\-]+)/,
        /youtu\.be\/([A-Za-z0-9_\-]+)/,
        /v=([A-Za-z0-9_\-]+)/,
      ];
      for (const p of patterns) {
        const m = url.match(p);
        if (m && m[1]) return m[1];
      }
      return null;
    }

    function makeThumbnail(channel) {
      const wrapper = document.createElement('div');
      wrapper.className = 'thumb';
      if (channel.type === 'youtube') {
        const id = extractYoutubeId(channel.url);
        if (id) {
          const img = document.createElement('img');
          img.src = `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
          img.alt = (channel.name || 'YouTube thumbnail') + ' thumbnail';
          wrapper.appendChild(img);
          return wrapper;
        }
      }
      // fallback placeholder
      wrapper.textContent = 'Preview';
      return wrapper;
    }

    function createIframe(channel) {
      const iframe = document.createElement('iframe');
      iframe.src = channel.url;
      iframe.title = channel.name || 'Video channel';
      iframe.loading = 'eager';
      iframe.width = 560;
      iframe.height = 315;
      iframe.style.width = '100%';
      iframe.style.height = '360px';
      iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
      iframe.allowFullscreen = true;
      // no sandbox here — many video players need features that sandbox blocks.
      iframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');
      iframe.style.border = '0';
      return iframe;
    }

    function render() {
      Object.keys(CHANNELS).forEach(key => {
        const group = CHANNELS[key];
        const groupEl = document.createElement('section');
        groupEl.className = 'group';
        const h = document.createElement('h2');
        h.textContent = group.label || key;
        groupEl.appendChild(h);

        (group.channels || []).forEach(channel => {
          const row = document.createElement('div');
          row.className = 'channel';

          const thumbWrap = document.createElement('div');
          const thumb = makeThumbnail(channel);
          thumbWrap.appendChild(thumb);

          const meta = document.createElement('div');
          meta.className = 'meta';
          const name = document.createElement('div');
          name.className = 'name';
          name.textContent = channel.name || 'Unnamed channel';

          const actions = document.createElement('div');
          actions.className = 'actions';

          const play = document.createElement('button');
          play.className = 'play';
          play.textContent = 'Play';
          play.type = 'button';

          const open = document.createElement('a');
          open.className = 'fallback';
          open.href = channel.url || '#';
          open.target = '_blank';
          open.rel = 'noopener noreferrer';
          open.textContent = 'Open in new tab';

          const small = document.createElement('div');
          small.className = 'small';
          small.textContent = channel.type ? channel.type : '';

          // Add behavior: replace thumbnail with iframe on Play
          play.addEventListener('click', () => {
            // create container so iframe keeps aspect ratio and can be swapped
            const frameWrap = document.createElement('div');
            frameWrap.className = 'iframe-wrap';
            const loadingNote = document.createElement('div');
            loadingNote.className = 'small';
            loadingNote.textContent = 'Loading…';
            frameWrap.appendChild(loadingNote);

            // replace thumbnail area with the frameWrap
            thumbWrap.replaceChild(frameWrap, thumbWrap.firstChild);

            const iframe = createIframe(channel);

            // listen for load event; if it never fires within timeout, show fallback
            let loaded = false;
            iframe.addEventListener('load', () => {
              loaded = true;
            });

            // Insert iframe (attempt)
            frameWrap.replaceChild(iframe, loadingNote);

            // After 3s, if iframe hasn't fired load, provide a clear fallback option
            setTimeout(() => {
              if (!loaded) {
                // Replace iframe with a blocked message + open link
                const blocked = document.createElement('div');
                blocked.innerHTML = '<div class="blocked">Embedding appears to be blocked by the source.</div>';
                const openNow = document.createElement('a');
                openNow.href = channel.url || '#';
                openNow.target = '_blank';
                openNow.rel = 'noopener noreferrer';
                openNow.className = 'fallback';
                openNow.textContent = 'Open directly in a new tab';
                blocked.appendChild(openNow);
                frameWrap.replaceChild(blocked, iframe);
              }
            }, 3000);
          });

          actions.appendChild(play);
          actions.appendChild(open);

          meta.appendChild(name);
          meta.appendChild(actions);
          meta.appendChild(small);

          row.appendChild(thumbWrap);
          row.appendChild(meta);
          groupEl.appendChild(row);
        });

        groupsContainer.appendChild(groupEl);
      });
    }

    // small safety: ensure CHANNELS appears to be object
    try {
      if (typeof CHANNELS !== 'object') {
        groupsContainer.textContent = 'No channels configured.';
      } else {
        render();
      }
    } catch (err) {
      console.error('Render error:', err);
      groupsContainer.textContent = 'An error occurred while rendering channels.';
    }
  </script>
</body>
</html>